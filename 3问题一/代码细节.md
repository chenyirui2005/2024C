# 关于问题一：最优种植策略的算法实现与分析

#### 1. 概述 (Overview)

本项目旨在为问题一提出的7年种植规划问题，构建一个高效的优化求解模型。该问题是一个包含多重复杂约束（如重茬、豆类轮作等）的大规模组合优化问题。

经过对多种方案的评估与测试，我们最终选择并实现了一种**深度定制的修复式遗传算法 (Repair-based Genetic Algorithm)**。该算法通过将农业领域的专业知识（约束规则）深度融入核心算子，成功地在巨大的搜索空间中找到了高质量的可行解，最终计算出的7年总利润在**数千万级别**，符合预期。

本文档将详细阐述代码的实现流程、算法的设计思路与细节，以及如何运行代码和解读结果。

#### 2. 文件结构说明 (File Structure)

为保证项目清晰，我们采用以下文件结构：

* **Project_Root/**
  * **3问题一/**
    * `solve_q1_final.py`: [核心] 问题一的最终求解代码 (修复式GA)
    * `run_sensitivity_analysis_area.py`: [核心] 土地面积灵敏度分析代码
  * **Data/**
    * `附件1.xlsx`: 包含地块和作物基础信息
    * `附件2.xlsx`: 包含2023年统计和种植数据
  * **Result/**
    * `result1_waste.xlsx`: 情景一(浪费)的最优种植方案
    * `result1_discount.xlsx`: 情景二(折价)的最优种植方案
    * `ga_log_waste.csv`: [绘图数据] 情景一的收敛日志
    * `ga_log_discount.csv`: [绘图数据] 情景二的收敛日志
    * `sensitivity_area.png`: 土地面积灵敏度分析结果图

#### 3. 算法实现环境与流程 (Implementation Environment & Process)

本项目的算法实现依赖于多个核心Python库，包括用于数据处理的 `pandas`、科学计算的 `numpy`、以及用于数据可视化的 `matplotlib` 和 `seaborn`。

整个求解流程分为两个主要步骤。首先，执行主求解脚本 `solve_q1_final.py`，该脚本负责读取数据、执行修复式遗传算法、对两种销售情景分别进行优化求解，并最终生成包含最优种植方案的Excel结果文件和用于后续分析的CSV日志文件。随后，可以执行 `run_sensitivity_analysis_area.py` 脚本，该脚本会多次调用核心算法，以分析关键参数变化对最终利润的影响，并生成可视化的分析图表。

#### 4. 算法选择与设计思路 (Algorithm Selection & Design Rationale)

##### 4.1 核心问题定性

本问题是一个典型的**NP-Hard组合优化问题**。其解空间巨大（所有可能的7年种植计划），且包含多重复杂的“硬”约束（如重茬、豆类轮作）。这决定了传统的精确求解方法（如穷举）是不可行的。

##### 4.2 算法选型：为什么是修复式遗传算法？

我们在多种可行方案中进行了比较和实践：

* **精确求解器 (如 Pyomo/CBC)**：这类工具能保证找到全局最优解。但对于此类问题，建模过程复杂，且随着问题规模和非线性因素的增加，求解时间可能变得非常长。在竞赛场景下，我们需要一个更灵活、更鲁棒的模型。
* **基础遗传算法 (依赖惩罚函数)**：这是我们最初尝试的路径。实践证明，对于本问题严格且复杂的约束，单纯的惩罚机制效果很差。算法生成的随机解几乎全部违规，导致适应度被巨额罚款淹没，算法无法有效收敛。
* **修复式遗传算法 (最终选择)**：这是我们最终采用的成功方案。它汲取了遗传算法强大的全局搜索能力，并通过一个**“修复函数 (Repair Function)”**，将农业领域的专业知识（约束规则）强制注入到算法的进化过程中。

  **选择理由**：该方法的核心优势在于，它确保了参与迭代的**每一个解始终是满足核心约束的可行解**。这极大地净化了搜索空间，使算法能专注于“如何让利润更高”，而不是在“如何避免被罚款”的泥潭中挣扎，从而实现了高效、稳定的收敛。

#### 5. 算法实现细节 (Implementation Details)

##### 5.1 解决方案编码 (Chromosome Encoding)

我们采用高度结构化的字典来编码一个个体（即一个完整的7年种植计划），格式如下：
`{年份: {季节: {地块名称: 作物名称}}}`
例如, `solution[2025][1]['A1'] = '玉米'` 表示2025年第一季在A1地块种植玉米。这种编码方式直观、易于理解和操作。

##### 5.2 适应度函数 (Fitness Function)

适应度函数被设定为问题一所要求的**7年总利润**，计算方式为：
Fitness = TotalProfit = Sum(Revenue_y - Cost_y) for y from 2024 to 2030.
我们根据“浪费(waste)”和“折价(discount)”两种情景，实现了两个版本的收入计算逻辑。此函数**不包含任何惩罚项**，因为所有核心约束都在修复函数中被处理。

##### 5.3 关键机制：修复函数 (`repair_solution`)

这是算法的“大脑”。在种群初始化和每次交叉、变异后，都会调用此函数。它执行两个核心修复任务：

* **修复重茬**：遍历所有地块和年份，检查是否存在与前一年相同的作物。如果存在，则从一个不包含前一年作物的、合法的候选作物列表中，随机选择一个进行替换。
* **修复豆类缺失**：遍历所有地块和所有3年窗口期（从2023年开始）。如果发现某个窗口期内没有种植豆类作物，则会强制在该窗口的某一年随机选择一个季节，将原作物替换为一个合法的、且不与前一年重茬的豆类作物。

##### 5.4 遗传算子 (Genetic Operators)

* **选择 (Selection)**：采用经典的**锦标赛选择**，每次随机选取 `k` (默认为3) 个个体，将其中适应度最高的个体作为父代。
* **交叉 (Crossover)**：采用**按地块交叉**，即以一定的概率随机选择一些地块，然后将两个父代方案中这些地块的完整7年种植历史进行交换。
* **变异 (Mutation)**：采用**引导式变异**，随机选择方案中的几个“基因”（某个地块在某年某季的种植决策），并从一个预先筛选好的“合法作物列表”中随机选择一种新作物进行替换，保证了变异操作不会引入明显不合理的作物。

##### 5.5 主要超参数设置 (Key Hyperparameter Settings)

我们在代码中设定了以下关键超参数，这些值是在测试中被证明表现良好的：

* 种群大小 (`POP_SIZE`): 100
* 最大迭代代数 (`MAX_GEN`): 200
* 交叉概率 (`CX_PROB`): 0.8
* 变异概率 (`MUT_PROB`): 0.2

### **6. 结果分析与可视化 (Results Analysis & Visualization)**

为了深入验证模型的有效性并挖掘数据背后的经济规律，我们设计并执行了收敛性分析和多维度灵敏度分析，并将分析结果进行了可视化呈现。

#### **6.1 收敛性分析**

在求解完成后，我们通过绘制遗传算法的收敛曲线来评估算法的性能。

* **实现方法** ：主求解脚本 (`solve_q1_final.py`) 在运行过程中，会记录每一代种群的**“历史最优适应度” **（Best Fitness）和** “种群平均适应度”**（Average Fitness），并将其保存到 `.csv` 日志文件中。独立的绘图脚本 (`plot_convergence.py`) 会读取此日志文件。
* **可视化呈现** ：
* **图表样式** ：生成的收敛曲线图以“迭代代数”为横轴，以“适应度（7年总利润）”为纵轴。
* **曲线解读** ：“历史最优适应度”曲线展示了算法搜索到的最优解的进化轨迹，我们期望看到它快速上升并最终收斂于一个稳定的高值。“种群平均适应度”曲线则反映了整个种群的总体表现。两条曲线之间的差距可以帮助我们评估种群的多样性。
* **风格** ：图表采用了符合学术规范的专业风格，包含清晰的图例、标题、坐标轴标签，并对坐标轴单位（万元）和最终收敛值进行了标注，确保了图表的高可读性。

#### **6.2 灵敏度分析**

灵敏度分析旨在探究当模型的关键参数发生变化时，最优决策（即最高总利润）会受到多大程度的影响。我们采用了**“一次单因素变动（One-at-a-Time, OAT）”**的方法，即每次只改变一个参数，并保持其他参数不变，然后重新运行完整的优化过程，观察结果的变化。

##### **6.2.1 约束参数 p 和 q 的灵敏度分析**

* **分析目标** ：探究模型的总利润对两个关键多样性约束参数的敏感程度。
* **参数p** : 地块内允许种植的作物种类数量上限。
* **参数q** : 一种作物允许种植的地块类型数量上限。
* **实现流程** ：我们编写了专门的分析脚本 (`run_sensitivity_analysis_p_q.py`)。该脚本会：

1. 设定一组 `p` 的测试值（例如 `[1, 2, 3, 4]`），并固定 `q` 为基准值。随后，针对每个 `p` 值完整地运行一次修复式遗传算法，记录下对应的最优总利润。
2. 设定一组 `q` 的测试值（例如 `[2, 3, 4, 5]`），并固定 `p` 为基准值，重复上述求解过程。

* **可视化呈现** ：分析结果被绘制在两个并列的折线图中。
* **左图** ：展示了“最优总利润”随“参数p”变化的曲线。
* **右图** ：展示了“最优总利润”随“参数q”变化的曲线。
* **图表解读** ：曲线的**斜率**直观地反映了利润对该参数的敏感度。斜率越陡峭，表示总利润对该参数的变化越敏感。

##### **6.2.2 土地面积的灵敏度分析**

* **分析目标** ：探究总利润对关键土地资源（不同地块类型）总面积变化的敏感程度，以识别最重要的土地资产。
* **实现流程** ：分析脚本 (`run_sensitivity_analysis_area.py`) 会：

1. 选定几种关键地块类型进行分析，例如“普通大棚”、“智慧大棚”和“水浇地”。
2. 设定一个面积缩放系数范围（例如 `[80%, 90%, 100%, 110%, 120%]`）。
3. 对每一种地块类型，依次应用所有缩放系数来调整其总面积，并对每种调整情况都完整地运行一次遗传算法，记录最优利润。

* **可视化呈现** ：
* **图表样式** ：分析结果被绘制在一个多曲线的折线图中。横轴为“总面积缩放比例”，纵轴为“最优7年总利润”。图中的每一条曲线代表一种地块类型。
* **图表解读** ：通过对比不同曲线的陡峭程度，可以清晰地判断出哪种地块类型的面积变化对村庄的总体经济效益影响最大。例如，如果“智慧大棚”的曲线最为陡峭，则说明增加智慧大棚的面积是提升总利润的最有效途径。

#### 7. 总结 (Conclusion)

本项目的算法实现，通过采用一种结合了领域知识的修复式遗传算法，成功解决了传统GA在处理强约束问题上的收敛困难。该方法不仅保证了解的有效性和合规性，还能在巨大的搜索空间中稳定地找到高质量的、利润可观的种植方案，为问题一提供了可靠且高效的计算机求解方案。
